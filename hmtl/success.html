<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pago exitoso</title>
</head>
<body>
  <h2 id="status-message">Procesando tu reserva...</h2>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="/js/firebaseConfig.js"></script> <!-- Verifica que la ruta sea correcta -->

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get("session_id");
      const statusEl = document.getElementById("status-message");
      const apiBase = `https://us-central1-antuanemakeup-7950c.cloudfunctions.net/api`;

      if (!sessionId) {
        statusEl.textContent = "ID de sesión no proporcionada.";
        return;
      }

      // 1) Recuperar datos de sesión desde backend
      fetch(`${apiBase}/getSession?session_id=${sessionId}`)
        .then(res => {
          if (!res.ok) throw new Error("Error al recuperar datos de la sesión.");
          return res.json();
        })
        .then(session => {
          const m = session.metadata || {};
          const reservation = {
            service:   m.service   || "",
            price:     m.price     || "",
            duration:  m.duration  || "",
            date:      m.date      || "",
            time:      m.time      || "",
            firstName: m.firstName || "",
            lastName:  m.lastName  || "",
            email:     session.customer_email || "",
            phone:     m.phone     || "",
            category:  m.category  || ""  // Incluir categoría en la reserva
          };

          // 2) Guardar reserva en Firebase
          return firebase.database().ref("reservations").push(reservation)
            .then(ref => ({ reservation, key: ref.key }));
        })
        .then(({ reservation, key }) => {
          // 3) Mostrar mensaje de éxito, incluyendo la categoría
          statusEl.innerHTML = `¡Pago exitoso!<br>
            Reserva confirmada para <strong>${reservation.firstName} ${reservation.lastName}</strong>.<br>
            <strong>Servicio:</strong> ${reservation.service}<br>
            <strong>Fecha:</strong> ${reservation.date}<br>
            <strong>Hora:</strong> ${reservation.time}<br>
            <strong>Categoría:</strong> ${reservation.category}`;  // Mostrar categoría

          // 4) Enviar correo de cancelación
          return fetch(`${apiBase}/sendCancellationEmail`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              reservationKey: key,
              session_id: sessionId,
              email: reservation.email,
              date: reservation.date,
              time: reservation.time,
              firstName: reservation.firstName
            })
          });
        })
        .then(response => {
          if (!response.ok) console.warn("No se envió el correo de cancelación.");
        })
        .catch(err => {
          console.error(err);
          statusEl.textContent = "Error al procesar tu reserva. Intenta más tarde.";
        });
    });
  </script>
</body>
</html>
